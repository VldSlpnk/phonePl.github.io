<!DOCTYPE html>
<html lang="ru">
   <head>
      <meta charset="UTF-8" />
      <title>–°–∫–∞–Ω–µ—Ä –Ω–æ–º–µ—Ä–∞</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      <!-- Telegram WebApp API -->
      <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <!-- Tesseract.js –¥–ª—è OCR -->
      <script src="https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js"></script>

      <style>
         * {
            box-sizing: border-box;
         }
         body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont,
               "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
         }
         #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
         }
         video {
            width: 100%;
            height: 100%;
            object-fit: cover;
         }
         /* –†–∞–º–∫–∞ –¥–ª—è –Ω–æ–º–µ—Ä–∞ (–ø–æ–∑–∏—Ü–∏—è –∏ —Ä–∞–∑–º–µ—Ä –∑–∞–¥–∞—é—Ç—Å—è JS, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ) */
         #frame {
            position: absolute;
            border: 3px solid #5a6aff;
            border-radius: 8px;
            pointer-events: auto;
         }
         /* –†—É—á–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª) */
         #frame-resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            border: 2px solid #cc00ff;
            background: rgba(0, 0, 0, 0.7);
            cursor: nwse-resize;
            touch-action: none;
         }

         #controls {
            padding: 12px;
            width: 100%;
            max-width: 500px;
         }
         #controls-top-text {
            text-align: center;
            margin-bottom: 8px;
         }
         .btn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
         }
         button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            color: #fff;
         }
         #scan-btn {
            background: #ffe762;
         }
         #send-btn {
            background: #006fc4;
         }
         button:disabled {
            opacity: 0.6;
         }
         #status {
            font-size: 13px;
            min-height: 18px;
            margin-bottom: 4px;
         }
         #phones-list {
            list-style: none;
            padding-left: 0;
            margin: 4px 0 0;
            font-size: 14px;
            max-height: 120px;
            overflow-y: auto;
         }
         #phones-list li {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
         }
         #phones-list li span.li-text {
            flex: 1;
            min-width: 0;
         }
         .li-actions {
            display: flex;
            gap: 4px;
         }
         .small-btn {
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: transparent;
            color: #fff;
            flex: 0 0 auto;
         }
         .small-btn.danger {
            border-color: #ff7675;
            color: #ff7675;
         }

         /* –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –≤–Ω–∏–∑—É */
         #edit-panel {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            padding: 8px 12px 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
         }
         #edit-panel.visible {
            display: block;
         }
         #edit-panel-title {
            font-size: 13px;
            margin-bottom: 4px;
         }
         #edit-input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: #111;
            color: #fff;
            font-size: 14px;
            margin-bottom: 6px;
         }
         #edit-buttons {
            display: flex;
            gap: 8px;
         }
         #edit-save-btn,
         #edit-cancel-btn {
            flex: 1;
            padding: 8px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            color: #fff;
         }
         #edit-save-btn {
            background: #00b894;
         }
         #edit-cancel-btn {
            background: #636e72;
         }
      </style>
   </head>
   <body>
      <div id="video-container">
         <video id="video" autoplay playsinline></video>
         <div id="frame">
            <div id="frame-resize-handle"></div>
         </div>
      </div>

      <div id="controls">
         <div id="controls-top-text">
            –ù–∞–≤–æ–¥–∏ –Ω–æ–º–µ—Ä –≤ —Ä–∞–º–∫—É (–ø–æ —Ü–µ–Ω—Ç—Ä—É), —Å–∫–∞–Ω–∏—Ä—É–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥,
            —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π/—É–¥–∞–ª—è–π, –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–π.
         </div>

         <div id="status"></div>

         <div class="btn-row">
            <button id="scan-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
            <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
         </div>

         <ul id="phones-list"></ul>
      </div>

      <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ -->
      <div id="edit-panel">
         <div id="edit-panel-title">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä (9 —Ü–∏—Ñ—Ä, –º–æ–∂–Ω–æ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):
         </div>
         <input id="edit-input" type="text" inputmode="numeric" />
         <div id="edit-buttons">
            <button id="edit-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="edit-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
         </div>
      </div>

      <script>
         const tg = window.Telegram.WebApp;
         tg.expand();

         const videoContainer = document.getElementById("video-container");
         const video = document.getElementById("video");
         const frame = document.getElementById("frame");
         const frameHandle = document.getElementById("frame-resize-handle");
         const scanBtn = document.getElementById("scan-btn");
         const sendBtn = document.getElementById("send-btn");
         const statusEl = document.getElementById("status");
         const phonesListEl = document.getElementById("phones-list");

         const editPanel = document.getElementById("edit-panel");
         const editInput = document.getElementById("edit-input");
         const editSaveBtn = document.getElementById("edit-save-btn");
         const editCancelBtn = document.getElementById("edit-cancel-btn");

         let scannedPhones = [];
         let editingIndex = null;

         function setStatus(msg) {
            statusEl.textContent = msg || "";
         }

         // –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É (–∑–∞–¥–Ω—è—è)
         navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then((stream) => {
               video.srcObject = stream;
            })
            .catch((err) => {
               console.error(err);
               setStatus(
                  "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
               );
               if (tg && tg.showAlert) {
                  tg.showAlert(
                     "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ."
                  );
               }
            });

         // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–º–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É ===
         function initFrame() {
            const containerRect = videoContainer.getBoundingClientRect();
            const initWidth = containerRect.width * 0.8; // 80% —à–∏—Ä–∏–Ω—ã
            const initHeight = containerRect.height * 0.2; // 20% –≤—ã—Å–æ—Ç—ã

            frame.style.width = initWidth + "px";
            frame.style.height = initHeight + "px";
            frame.style.left = (containerRect.width - initWidth) / 2 + "px";
            frame.style.top = (containerRect.height - initHeight) / 2 + "px";
         }

         // –í—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ layout
         window.addEventListener("load", initFrame);

         // ========= –†–µ—Å–∞–π–∑ —Ä–∞–º–∫–∏ –û–¢ –¶–ï–ù–¢–†–ê =========
         let isResizing = false;
         let startX, startY, startWidth, startHeight;
         let centerX, centerY; // —Ü–µ–Ω—Ç—Ä —Ä–∞–º–∫–∏ (–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)

         function getClientXY(e) {
            if (e.touches && e.touches[0]) {
               return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
         }

         function startResize(e) {
            e.preventDefault();
            isResizing = true;

            const rect = frame.getBoundingClientRect();
            const containerRect = videoContainer.getBoundingClientRect();

            startWidth = rect.width;
            startHeight = rect.height;

            // –¶–µ–Ω—Ç—Ä —Ä–∞–º–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            centerX = rect.left - containerRect.left + rect.width / 2;
            centerY = rect.top - containerRect.top + rect.height / 2;

            const { x, y } = getClientXY(e);
            startX = x;
            startY = y;
         }

         function onResize(e) {
            if (!isResizing) return;
            e.preventDefault();

            const { x, y } = getClientXY(e);
            const dx = x - startX;
            const dy = y - startY;

            const containerRect = videoContainer.getBoundingClientRect();

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º/—É–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä, —Ü–µ–Ω—Ç—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ
            let newWidth = startWidth + dx;
            let newHeight = startHeight + dy;

            const minWidth = containerRect.width * 0.2;
            const minHeight = containerRect.height * 0.1;
            const maxWidth = containerRect.width * 0.95;
            const maxHeight = containerRect.height * 0.95;

            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

            frame.style.width = newWidth + "px";
            frame.style.height = newHeight + "px";

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º left/top —Ç–∞–∫, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º
            frame.style.left = centerX - newWidth / 2 + "px";
            frame.style.top = centerY - newHeight / 2 + "px";
         }

         function stopResize() {
            isResizing = false;
         }

         frameHandle.addEventListener("mousedown", startResize);
         frameHandle.addEventListener("touchstart", startResize, {
            passive: false,
         });

         window.addEventListener("mousemove", onResize);
         window.addEventListener("touchmove", onResize, { passive: false });

         window.addEventListener("mouseup", stopResize);
         window.addEventListener("touchend", stopResize);

         // ========= –†–∞–±–æ—Ç–∞ —Å –Ω–æ–º–µ—Ä–∞–º–∏ =========

         // –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -> –ø–æ–ª—å—Å–∫–∏–π –Ω–æ–º–µ—Ä "881 724 870"
         function extractPhone(text) {
            text = text.replace(/\s+/g, " ");
            console.log("OCR raw text:", text);

            const re = /(?:\+48\s*)?(\d{3})\D?(\d{3})\D?(\d{3})/;
            const m = text.match(re);
            if (!m) return null;
            return `${m[1]} ${m[2]} ${m[3]}`;
         }

         // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞, –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
         function normalizeManualPhone(input) {
            const digits = (input.match(/\d/g) || []).join("");
            if (digits.length !== 9) return null;
            return `${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(
               6
            )}`;
         }

         function openEditPanel(index) {
            editingIndex = index;
            editInput.value = scannedPhones[index] || "";
            editPanel.classList.add("visible");
            editInput.focus();
            editInput.select();
         }

         function closeEditPanel() {
            editingIndex = null;
            editPanel.classList.remove("visible");
         }

         function renderPhonesList() {
            phonesListEl.innerHTML = "";
            if (!scannedPhones.length) {
               setStatus("–ù–æ–º–µ—Ä–∞ –µ—â—ë –Ω–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.");
               return;
            }
            setStatus(`–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–º–µ—Ä–æ–≤: ${scannedPhones.length}`);

            scannedPhones.forEach((p, idx) => {
               const li = document.createElement("li");

               const textSpan = document.createElement("span");
               textSpan.className = "li-text";
               textSpan.textContent = `${idx + 1}. ${p}`;

               const actions = document.createElement("span");
               actions.className = "li-actions";

               const editBtn = document.createElement("button");
               editBtn.type = "button";
               editBtn.className = "small-btn";
               editBtn.textContent = "‚úèÔ∏è";
               editBtn.addEventListener("click", () => {
                  openEditPanel(idx);
               });

               const delBtn = document.createElement("button");
               delBtn.type = "button";
               delBtn.className = "small-btn danger";
               delBtn.textContent = "üóëÔ∏è";
               delBtn.addEventListener("click", () => {
                  const value = scannedPhones[idx];
                  scannedPhones.splice(idx, 1);
                  setStatus(`–ù–æ–º–µ—Ä —É–¥–∞–ª—ë–Ω: ${value}`);
                  renderPhonesList();
               });

               actions.appendChild(editBtn);
               actions.appendChild(delBtn);

               li.appendChild(textSpan);
               li.appendChild(actions);
               phonesListEl.appendChild(li);
            });
         }

         // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
         editSaveBtn.addEventListener("click", () => {
            if (editingIndex === null) {
               closeEditPanel();
               return;
            }
            const raw = editInput.value || "";
            const normalized = normalizeManualPhone(raw);
            if (!normalized) {
               setStatus("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ä–æ–≤–Ω–æ 9 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä 881724870.");
               return;
            }
            scannedPhones[editingIndex] = normalized;
            setStatus(`–ù–æ–º–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω: ${normalized}`);
            closeEditPanel();
            renderPhonesList();
         });

         editCancelBtn.addEventListener("click", () => {
            closeEditPanel();
         });

         // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
         scanBtn.addEventListener("click", async () => {
            if (!video.videoWidth || !video.videoHeight) {
               setStatus("–ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞, –ø–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.");
               return;
            }

            scanBtn.disabled = true;
            sendBtn.disabled = true;
            setStatus("–°–∫–∞–Ω–∏—Ä—É—é –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é...");

            try {
               // 1. –ö–∞–¥—Ä —Ü–µ–ª–∏–∫–æ–º
               const canvas = document.createElement("canvas");
               canvas.width = video.videoWidth;
               canvas.height = video.videoHeight;
               const ctx = canvas.getContext("2d");
               ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

               // 2. –ö—Ä–æ–ø –ø–æ —Ä–∞–º–∫–µ
               const frameRect = frame.getBoundingClientRect();
               const videoRect = video.getBoundingClientRect();

               const relX = (frameRect.left - videoRect.left) / videoRect.width;
               const relY = (frameRect.top - videoRect.top) / videoRect.height;
               const relW = frameRect.width / videoRect.width;
               const relH = frameRect.height / videoRect.height;

               const cropCanvas = document.createElement("canvas");
               cropCanvas.width = canvas.width * relW;
               cropCanvas.height = canvas.height * relH;
               const cropCtx = cropCanvas.getContext("2d");

               cropCtx.drawImage(
                  canvas,
                  canvas.width * relX,
                  canvas.height * relY,
                  canvas.width * relW,
                  canvas.height * relH,
                  0,
                  0,
                  cropCanvas.width,
                  cropCanvas.height
               );

               // 3. OCR –ø–æ –≤—ã—Ä–µ–∑–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
               const result = await Tesseract.recognize(cropCanvas, "eng", {
                  logger: (m) => console.log(m),
               });

               const text = result.data.text || "";
               const phone = extractPhone(text);

               if (!phone) {
                  setStatus(
                     "–ù–µ –Ω–∞—à—ë–ª –Ω–æ–º–µ—Ä. –ü–æ–¥–Ω–µ—Å–∏ –±–ª–∏–∂–µ/—Ä–µ–∑—á–µ –∏–ª–∏ —É–≤–µ–ª–∏—á—å —Ä–∞–º–∫—É."
                  );
               } else {
                  if (!scannedPhones.includes(phone)) {
                     scannedPhones.push(phone);
                     setStatus(`–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–º–µ—Ä: ${phone}`);
                  } else {
                     setStatus(`–ù–æ–º–µ—Ä —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ: ${phone}`);
                  }
                  renderPhonesList();
               }
            } catch (e) {
               console.error(e);
               setStatus("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
            } finally {
               scanBtn.disabled = false;
               sendBtn.disabled = false;
            }
         });

         // –û—Ç–ø—Ä–∞–≤–∫–∞
         sendBtn.addEventListener("click", () => {
            if (!scannedPhones.length) {
               setStatus("–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");
               return;
            }
            const payload = JSON.stringify(scannedPhones);
            tg.sendData(payload);
            tg.close();
         });

         // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
         renderPhonesList();
      </script>
   </body>
</html>
