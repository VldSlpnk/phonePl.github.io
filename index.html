<!DOCTYPE html>
<html lang="ru">
   <head>
      <meta charset="UTF-8" />
      <title>–°–∫–∞–Ω–µ—Ä –Ω–æ–º–µ—Ä–∞</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />

      <!-- Telegram WebApp API -->
      <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <!-- Tesseract.js –¥–ª—è OCR -->
      <script src="https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js"></script>

      <style>
         * {
            box-sizing: border-box;
         }
         body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont,
               "Segoe UI", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
         }
         #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
         }
         video {
            width: 100%;
            height: 100%;
            object-fit: cover;
         }
         /* –†–∞–º–∫–∞ –¥–ª—è –Ω–æ–º–µ—Ä–∞ */
         #frame {
            position: absolute;
            border: 3px solid #0066ff;
            border-radius: 8px;
            width: 80%;
            height: 20%;
            top: 40%;
            left: 10%;
            pointer-events: auto; /* —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–∞—Ç—å –ø–æ —Ä—É—á–∫–µ */
         }
         /* –†—É—á–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª) */
         #frame-resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            border: 2px solid #003a7c;
            background: rgba(0, 0, 0, 0.7);
            cursor: nwse-resize;
            touch-action: none;
         }

         #controls {
            padding: 12px;
            width: 100%;
            max-width: 500px;
         }
         #controls-top-text {
            text-align: center;
            margin-bottom: 8px;
         }
         .btn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
         }
         button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            color: #fff;
         }
         #scan-btn {
            background: #ffde22;
         }
         #send-btn {
            background: #00b460;
         }
         button:disabled {
            opacity: 0.6;
         }
         #status {
            font-size: 13px;
            min-height: 18px;
            margin-bottom: 4px;
         }
         #phones-list {
            list-style: none;
            padding-left: 0;
            margin: 4px 0 0;
            font-size: 14px;
            max-height: 120px;
            overflow-y: auto;
         }
         #phones-list li {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
         }
         #phones-list li span.li-text {
            flex: 1;
            min-width: 0;
         }
         .li-actions {
            display: flex;
            gap: 4px;
         }
         .small-btn {
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: transparent;
            color: #fff;
            flex: 0 0 auto;
         }
         .small-btn.danger {
            border-color: #ff7675;
            color: #ff7675;
         }
      </style>
   </head>
   <body>
      <div id="video-container">
         <video id="video" autoplay playsinline></video>
         <div id="frame">
            <div id="frame-resize-handle"></div>
         </div>
      </div>

      <div id="controls">
         <div id="controls-top-text">
            –ù–∞–≤–æ–¥–∏ –Ω–æ–º–µ—Ä –≤ —Ä–∞–º–∫—É, —Å–∫–∞–Ω–∏—Ä—É–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥,
            —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π/—É–¥–∞–ª—è–π, –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–π.
         </div>

         <div id="status"></div>

         <div class="btn-row">
            <button id="scan-btn">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
            <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
         </div>

         <ul id="phones-list"></ul>
      </div>

      <script>
         const tg = window.Telegram.WebApp;
         tg.expand();

         const videoContainer = document.getElementById("video-container");
         const video = document.getElementById("video");
         const frame = document.getElementById("frame");
         const frameHandle = document.getElementById("frame-resize-handle");
         const scanBtn = document.getElementById("scan-btn");
         const sendBtn = document.getElementById("send-btn");
         const statusEl = document.getElementById("status");
         const phonesListEl = document.getElementById("phones-list");

         let scannedPhones = [];

         // –í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É (–∑–∞–¥–Ω—è—è)
         navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then((stream) => {
               video.srcObject = stream;
            })
            .catch((err) => {
               alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É: " + err);
            });

         // ========= –†–µ—Å–∞–π–∑ —Ä–∞–º–∫–∏ =========
         let isResizing = false;
         let startX, startY, startWidth, startHeight;

         function getClientXY(e) {
            if (e.touches && e.touches[0]) {
               return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
         }

         function startResize(e) {
            e.preventDefault();
            isResizing = true;
            const rect = frame.getBoundingClientRect();
            startWidth = rect.width;
            startHeight = rect.height;

            const { x, y } = getClientXY(e);
            startX = x;
            startY = y;
         }

         function onResize(e) {
            if (!isResizing) return;
            e.preventDefault();

            const { x, y } = getClientXY(e);
            const dx = x - startX;
            const dy = y - startY;

            const containerRect = videoContainer.getBoundingClientRect();

            let newWidth = startWidth + dx;
            let newHeight = startHeight + dy;

            const minWidth = containerRect.width * 0.2;
            const minHeight = containerRect.height * 0.1;
            const maxWidth = containerRect.width * 0.95;
            const maxHeight = containerRect.height * 0.95;

            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

            frame.style.width = newWidth + "px";
            frame.style.height = newHeight + "px";
         }

         function stopResize() {
            isResizing = false;
         }

         frameHandle.addEventListener("mousedown", startResize);
         frameHandle.addEventListener("touchstart", startResize, {
            passive: false,
         });

         window.addEventListener("mousemove", onResize);
         window.addEventListener("touchmove", onResize, { passive: false });

         window.addEventListener("mouseup", stopResize);
         window.addEventListener("touchend", stopResize);

         // ========= –†–∞–±–æ—Ç–∞ —Å –Ω–æ–º–µ—Ä–∞–º–∏ =========

         // –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -> –ø–æ–ª—å—Å–∫–∏–π –Ω–æ–º–µ—Ä "881 724 870"
         function extractPhone(text) {
            text = text.replace(/\s+/g, " ");
            console.log("OCR raw text:", text);

            const re = /(?:\+48\s*)?(\d{3})\D?(\d{3})\D?(\d{3})/;
            const m = text.match(re);
            if (!m) return null;
            return `${m[1]} ${m[2]} ${m[3]}`;
         }

         // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞, –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
         function normalizeManualPhone(input) {
            const digits = (input.match(/\d/g) || []).join("");
            if (digits.length !== 9) return null;
            return `${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(
               6
            )}`;
         }

         function renderPhonesList() {
            phonesListEl.innerHTML = "";
            if (!scannedPhones.length) {
               statusEl.textContent = "–ù–æ–º–µ—Ä–∞ –µ—â—ë –Ω–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.";
               return;
            }
            statusEl.textContent = `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–º–µ—Ä–æ–≤: ${scannedPhones.length}`;

            scannedPhones.forEach((p, idx) => {
               const li = document.createElement("li");

               const textSpan = document.createElement("span");
               textSpan.className = "li-text";
               textSpan.textContent = `${idx + 1}. ${p}`;

               const actions = document.createElement("span");
               actions.className = "li-actions";

               const editBtn = document.createElement("button");
               editBtn.type = "button";
               editBtn.className = "small-btn";
               editBtn.textContent = "‚úèÔ∏è";

               editBtn.addEventListener("click", () => {
                  const current = scannedPhones[idx];
                  const newVal = prompt(
                     "–ò–∑–º–µ–Ω–∏ –Ω–æ–º–µ—Ä (–º–æ–∂–Ω–æ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):",
                     current
                  );
                  if (!newVal) return;

                  const normalized = normalizeManualPhone(newVal);
                  if (!normalized) {
                     alert(
                        "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –Ω–æ–º–µ—Ä. –í–≤–µ–¥–∏ 9 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä 881724870 –∏–ª–∏ 881 724 870."
                     );
                     return;
                  }
                  scannedPhones[idx] = normalized;
                  statusEl.textContent = `–ù–æ–º–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω: ${normalized}`;
                  renderPhonesList();
               });

               const delBtn = document.createElement("button");
               delBtn.type = "button";
               delBtn.className = "small-btn danger";
               delBtn.textContent = "üóëÔ∏è";

               delBtn.addEventListener("click", () => {
                  const value = scannedPhones[idx];
                  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä ${value}?`)) return;
                  scannedPhones.splice(idx, 1);
                  statusEl.textContent = `–ù–æ–º–µ—Ä —É–¥–∞–ª—ë–Ω: ${value}`;
                  renderPhonesList();
               });

               actions.appendChild(editBtn);
               actions.appendChild(delBtn);

               li.appendChild(textSpan);
               li.appendChild(actions);
               phonesListEl.appendChild(li);
            });
         }

         scanBtn.addEventListener("click", async () => {
            if (!video.videoWidth || !video.videoHeight) {
               alert("–ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞, –ø–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.");
               return;
            }

            scanBtn.disabled = true;
            sendBtn.disabled = true;
            statusEl.textContent = "–°–∫–∞–Ω–∏—Ä—É—é –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é...";

            try {
               // 1. –ö–∞–¥—Ä —Ü–µ–ª–∏–∫–æ–º
               const canvas = document.createElement("canvas");
               canvas.width = video.videoWidth;
               canvas.height = video.videoHeight;
               const ctx = canvas.getContext("2d");
               ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

               // 2. –ö—Ä–æ–ø –ø–æ —Ä–∞–º–∫–µ
               const frameRect = frame.getBoundingClientRect();
               const videoRect = video.getBoundingClientRect();

               const relX = (frameRect.left - videoRect.left) / videoRect.width;
               const relY = (frameRect.top - videoRect.top) / videoRect.height;
               const relW = frameRect.width / videoRect.width;
               const relH = frameRect.height / videoRect.height;

               const cropCanvas = document.createElement("canvas");
               cropCanvas.width = canvas.width * relW;
               cropCanvas.height = canvas.height * relH;
               const cropCtx = cropCanvas.getContext("2d");

               cropCtx.drawImage(
                  canvas,
                  canvas.width * relX,
                  canvas.height * relY,
                  canvas.width * relW,
                  canvas.height * relH,
                  0,
                  0,
                  cropCanvas.width,
                  cropCanvas.height
               );

               // 3. OCR –ø–æ –≤—ã—Ä–µ–∑–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
               const result = await Tesseract.recognize(cropCanvas, "eng", {
                  logger: (m) => console.log(m),
               });

               const text = result.data.text || "";
               const phone = extractPhone(text);

               if (!phone) {
                  statusEl.textContent =
                     "–ù–µ –Ω–∞—à—ë–ª –Ω–æ–º–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–Ω–µ—Å—Ç–∏ –±–ª–∏–∂–µ/—Ä–µ–∑—á–µ.";
               } else {
                  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä, –¥—É–±–ª–∏–∫–∞—Ç—ã —Å–æ —Å–∫–∞–Ω–∞ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                  if (!scannedPhones.includes(phone)) {
                     scannedPhones.push(phone);
                     statusEl.textContent = `–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–º–µ—Ä: ${phone}`;
                  } else {
                     statusEl.textContent = `–ù–æ–º–µ—Ä —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ: ${phone}`;
                  }
                  renderPhonesList();
               }
            } catch (e) {
               console.error(e);
               alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: " + e);
            } finally {
               scanBtn.disabled = false;
               sendBtn.disabled = false;
            }
         });

         sendBtn.addEventListener("click", () => {
            if (!scannedPhones.length) {
               alert(
                  "–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω."
               );
               return;
            }

            const payload = JSON.stringify(scannedPhones);
            tg.sendData(payload);
            tg.close();
         });

         // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
         renderPhonesList();
      </script>
   </body>
</html>
